async function performRobustLogin(env) {
  try {
    console.log('ğŸ” Starting login process...');
    
    // 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’å–å¾—
    const loginPageResponse = await fetch('https://www.comisapolive.com/login/', {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8'
      }
    });
    
    if (!loginPageResponse.ok) {
      return { success: false, error: `Login page failed: ${loginPageResponse.status}` };
    }
    
    const loginPageHtml = await loginPageResponse.text();
    const loginPageCookies = loginPageResponse.headers.get('set-cookie') || '';
    
    // 2. ãƒ•ã‚©ãƒ¼ãƒ æƒ…å ±ã‚’æŠ½å‡º
    const csrfToken = extractCSRFToken(loginPageHtml);
    const hiddenFields = extractHiddenFields(loginPageHtml);
    const actionUrl = extractFormAction(loginPageHtml) || 'https://www.comisapolive.com/login/';
    
    console.log('ğŸ“ Form analysis complete:', {
      csrf: !!csrfToken,
      hidden: Object.keys(hiddenFields).length,
      action: actionUrl.includes('login')
    });
    
    // 3. ãƒ­ã‚°ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const loginData = new URLSearchParams();
    
    // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ï¼ˆfallbackä»˜ãï¼‰
    const email = env.LOGIN_ID || 'comisapolive@gmail.com';
    const password = env.LOGIN_PASSWORD || 'cord3cord3';
    
    // è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦è¡Œ
    const emailFields = ['email', 'username', 'login_id', 'user_email', 'mail'];
    const passwordFields = ['password', 'passwd', 'pass', 'login_password'];
    
    emailFields.forEach(field => {
      loginData.append(field, email);
    });
    
    passwordFields.forEach(field => {
      loginData.append(field, password);
    });
    
    // CSRFå¯¾å¿œ
    if (csrfToken) {
      const csrfFields = ['csrf_token', '_token', 'authenticity_token', 'csrfmiddlewaretoken'];
      csrfFields.forEach(field => {
        loginData.append(field, csrfToken);
      });
    }
    
    // hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
    Object.entries(hiddenFields).forEach(([name, value]) => {
      loginData.append(name, value);
    });
    
    // 4. ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    const loginResponse = await fetch(actionUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Referer': 'https://www.comisapolive.com/login/',
        'Origin': 'https://www.comisapolive.com',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Cookie': loginPageCookies
      },
      body: loginData.toString(),
      redirect: 'manual'
    });
    
    const loginResponseCookies = loginResponse.headers.get('set-cookie') || '';
	const allCookies = combineCookies(loginPageCookies, loginResponseCookies);

	// ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
	console.log('ğŸ” Login response analysis:', {
	status: loginResponse.status,
	url: loginResponse.url,
	hasSetCookie: !!loginResponseCookies,
	cookieLength: loginResponseCookies.length,
	totalCookieLength: allCookies.length
	});

	// 5. æˆåŠŸåˆ¤å®š
	let success = false;
	let method = '';
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¤å®š
    if (loginResponse.status >= 300 && loginResponse.status < 400) {
	const location = loginResponse.headers.get('location');
	console.log('ğŸ“ Redirect detected:', { 
		location, 
		hasLogin: location?.includes('login'),
		hasError: location?.includes('error')
	});
	
	if (location && !location.includes('login') && !location.includes('error')) {
		success = true;
		method = 'redirect';
	}
	}
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹åˆ¤å®š
	if (!success) {
	const loginResponseText = await loginResponse.text();
	console.log('ğŸ“„ Response preview (first 300 chars):', loginResponseText.substring(0, 300));
	console.log('ğŸ“Š Response length:', loginResponseText.length);
	
	const successPatterns = ['dashboard', 'ãƒã‚¤ãƒšãƒ¼ã‚¸', 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', 'menu', 'profile', 'liver', 'è¨­å®š', 'ãƒ›ãƒ¼ãƒ ', 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'];
	const failurePatterns = ['ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•', 'èªè¨¼ã«å¤±æ•—', 'error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'];
	
	const hasSuccess = successPatterns.some(pattern => 
		loginResponseText.toLowerCase().includes(pattern.toLowerCase())
	);
	const hasFailure = failurePatterns.some(pattern => 
		loginResponseText.toLowerCase().includes(pattern.toLowerCase())
	);
	
	console.log('ğŸ¯ Pattern matching:', { 
		hasSuccess, 
		hasFailure,
		foundSuccess: successPatterns.filter(p => loginResponseText.toLowerCase().includes(p.toLowerCase())),
		foundFailure: failurePatterns.filter(p => loginResponseText.toLowerCase().includes(p.toLowerCase()))
	});
	
	if (hasSuccess && !hasFailure) {
		success = true;
		method = 'content';
	}
	}
    
    // Cookieåˆ¤å®š
    if (!success && allCookies.length > loginPageCookies.length) {
      const sessionPatterns = ['session', 'auth', 'login', 'token', 'user'];
      const hasSessionCookie = sessionPatterns.some(pattern =>
        allCookies.toLowerCase().includes(pattern)
      );
      
      if (hasSessionCookie) {
        success = true;
        method = 'cookie';
      }
    }

	// ã‚ˆã‚Šç·©ã„æˆåŠŸåˆ¤å®šï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
	if (!success && loginResponse.status === 200) {
	const loginResponseText = await loginResponse.text();
	// ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ç‰¹å¾´ãŒãªã„å ´åˆã¯æˆåŠŸã¨ã¿ãªã™
	if (!loginResponseText.includes('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰') && 
		!loginResponseText.includes('ãƒ­ã‚°ã‚¤ãƒ³') && 
		loginResponseText.length > 1000) {
		success = true;
		method = 'fallback';
		console.log('ğŸ² Using fallback success detection - no login indicators found');
	}
	}
    
    console.log(`ğŸ” Login result: ${success ? 'âœ… SUCCESS' : 'âŒ FAILED'} (${method})`);
    
    return {
      success,
      cookies: allCookies,
      method,
      error: success ? null : 'Login failed - no success indicators found'
    };
    
  } catch (error) {
    console.error('Login error:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

function extractCSRFToken(html) {
  let match = html.match(/<meta[^>]*name=["\']csrf-token["\'][^>]*content=["\']([^"\']*)["\'][^>]*>/i);
  if (match) return match[1];
  
  match = html.match(/<meta[^>]*content=["\']([^"\']*)["\'][^>]*name=["\']csrf-token["\'][^>]*>/i);
  if (match) return match[1];
  
  match = html.match(/<input[^>]*name=["\']csrf_token["\'][^>]*value=["\']([^"\']*)["\'][^>]*>/i);
  if (match) return match[1];
  
  match = html.match(/<input[^>]*name=["\']_token["\'][^>]*value=["\']([^"\']*)["\'][^>]*>/i);
  if (match) return match[1];
  
  return null;
}

function extractHiddenFields(html) {
  const hiddenFields = {};
  const pattern = /<input[^>]*type=["\']hidden["\'][^>]*>/gi;
  let match;
  
  while ((match = pattern.exec(html)) !== null) {
    const input = match[0];
    const nameMatch = input.match(/name=["\']([^"\']*)["\']/i);
    const valueMatch = input.match(/value=["\']([^"\']*)["\']/i);
    
    if (nameMatch && valueMatch) {
      hiddenFields[nameMatch[1]] = valueMatch[1];
    }
  }
  
  return hiddenFields;
}

function extractFormAction(html) {
  const match = html.match(/<form[^>]*action=["\']([^"\']*)["\'][^>]*>/i);
  if (match) {
    const action = match[1];
    return action.startsWith('/') ? `https://www.comisapolive.com${action}` : action;
  }
  return null;
}

function combineCookies(cookies1, cookies2) {
  console.log('ğŸª Raw cookies1:', cookies1);
  console.log('ğŸª Raw cookies2:', cookies2);
  
  let finalCookies = '';
  
  if (cookies2 && cookies2.includes('SESS_PUBLISH')) {
    // cookies2ã‹ã‚‰æœ€æ–°ã®SESS_PUBLISHã‚’æŠ½å‡º
    const sessMatches = cookies2.match(/SESS_PUBLISH=([^;,]+)/g);
    if (sessMatches && sessMatches.length > 0) {
      // æœ€å¾Œã®ãƒãƒƒãƒã‚’ä½¿ç”¨
      finalCookies = sessMatches[sessMatches.length - 1];
      console.log('ğŸª Using latest SESS_PUBLISH:', finalCookies);
    }
  } else if (cookies1 && cookies1.includes('SESS_PUBLISH')) {
    // cookies1ã‹ã‚‰æŠ½å‡º
    const sessMatch = cookies1.match(/SESS_PUBLISH=([^;,]+)/);
    if (sessMatch) {
      finalCookies = `SESS_PUBLISH=${sessMatch[1]}`;
      console.log('ğŸª Using cookies1 SESS_PUBLISH:', finalCookies);
    }
  }
  
  return finalCookies;
}